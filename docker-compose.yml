version: '3.8'

services:
  db:
    image: postgres:12-alpine
    volumes: # should be commented when running locally
      - /var/lib/postgresql
    env_file:
      - .env.db
    ports:
      - target: 5432
        published: 5432

  front:
    image: "docker.pkg.github.com/squadster/squadster-frontend/frontend-release:latest"
    command: bash -c "serve -p 3000 -s ."
    deploy:
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3

  api:
    image: "docker.pkg.github.com/squadster/squadster-api/release:latest"
    command: bash -c "bin/squadster start"
    depends_on:
      - db
    deploy:
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3

  bot:
    image: "docker.pkg.github.com/squadster/mercury/bot:latest"
    command: sh -c "java --add-opens=java.base/jdk.internal.loader=ALL-UNNAMED -Dspring.profiles.active=release -jar /app.jar"
    #environment:
      #ELASTICSEARCH_HOST: "${ELASTICSEARCH_HOST}"
      #ELASTICSEARCH_PORT: "${ELASTICSEARCH_PORT}"
    depends_on:
      - db
    deploy:
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3

  nginx:
    image: "docker.pkg.github.com/squadster/squadster-deployment/nginx:latest"
    # build: nginx # need to redeploy image
    ports:
      - target: 80
        published: 80
    depends_on:
      - api
      - front
