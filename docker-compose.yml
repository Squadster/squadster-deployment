version: '3.8'

networks:
  default:
    driver: overlay

services:
  db:
    image: postgres:12-alpine
    env_file:
      - .env.db
    volumes:
      - /var/lib/postgresql
    networks:
      - default
    ports:
      - target: 5432
        published: 5432

  front:
    image: "docker.pkg.github.com/squadster/squadster-frontend/frontend-release:latest"
    command: bash -c "serve -p 3000 -s ."
    networks:
      - default
    deploy:
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3

  api:
    image: "docker.pkg.github.com/squadster/squadster-api/release:latest"
    command: bash -c "bin/squadster start"
    networks:
      - default
    depends_on:
      - db
    deploy:
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3

  bot:
    image: "docker.pkg.github.com/squadster/mercury/bot:latest"
    command: sh -c "java --add-opens=java.base/jdk.internal.loader=ALL-UNNAMED -Dspring.profiles.active=release -jar /app.jar"
    networks:
      - default
    depends_on:
      - db
    deploy:
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3

  nginx:
    image: "docker.pkg.github.com/squadster/squadster-deployment/nginx:latest"
    networks:
      - default
    ports:
      - target: 80
        published: 80
    depends_on:
      - api
      - front
